---
title: "Eksploratorna analiza IMDb movie skupa podataka"
author: '36557473 Milković Borna'
date: '`r Sys.Date()`'
output:
  pdf_document: default
  html_document: default
---
```{r setup, include = F}
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(tidyverse)
library(stringr)
library(readr)
library(GGally)
library(MASS)
library(sn)
library(gridExtra)
library(Hmisc)
library(broom)
library(corrplot)
library(car)
```

## Opis IMDb movies skupa podataka
Za početak ćemo učitati skup podataka i proučiti ga. U nastavku su navedena objašnjenja pojedinih stupaca:

- `movie_title` - naslov filma 
- `title_year` - godina izlaska filma
- `duration` - trajanje filma (u minutama)
- `color` - govori nam je li film u boji ili je crno bijeli ("Color", "Black and White")
- `genres` - žanrovi u kojima film pripada
- `director_name` - ime i prezime redatelja
- `country` - država produkcije filma
- `language` - jezik kojim se primarno priča u filmu
- `budget` - novac uložen u kreiranje filma
- `gross` -  novac zarađen na prodaji ulaznica za film
- `imdb_score` - ocjena filma na IMDb stranici (0-10)
- `content_rating` - oznaka za primjerenu dob gledatelja:
  `PG-13` - neprimjereno za djecu mlađu od 13 godina, 
  `R` - ograničeno gledanje za osobe mlađe od 17 godina, 
  `NC-17` - samo za odrasle, 
  ... (za više informacija: https://www.filmratings.com/)
- `num_user_for_reviews` - broj pisanih komentara gledatelja
- `num_critic_for_reviews` - broj profesionalnih recenzija
- `num_voted_users` - broj ljudi koji su dali ocjenu
- `movie_facebook_likes` - broj oznaka sviđanja na filmovoj facebook stranici
- `facenumber_in_poster` - broj ljudi vidljiv na plakatu filma
- `cast_total_facebook_likes` - oznake sviđanja svih glumaca u filmu
- `actor_1_name`, `actor_2_name`, `actor_3_name` - imena i prezimena glavna 3 glumca filma
- `director_facebook_likes` - oznake sviđanja za redatelja na facebooku

## Učitavanje i proučavanje skupa

```{r}
movies <- read.csv("../data/IMDB_movie_dataset.csv")
#head(movies)
glimpse(movies)
#summary(movies)
```
Skup podataka sastoji se od 5043 podatka opisanih s 28 stupaca. Skup podataka opisuje informacije o filmovima koji se nalaze na stranici IMDb (https://www.imdb.com), a najnoviji podaci su iz 2016. godine.

## Nedostajuće vrijednosti

U prvih par redaka možemo vidjeti neke nedostajuće vrijednosti (`NA`), ali također i prazne znakovne nizove (`""`) unutar pojedinih znakovnih stupaca. Prvo ćemo pretvoriti prazne znakovne nizove u nedostajuće vrijednosti.

```{r, results='hold'}

broj_nedostajucih_prije <- movies %>% is.na() %>% sum()

movies$color <- na_if(movies$color, "")
movies$director_name <- na_if(movies$director_name, "")
movies$actor_2_name <- na_if(movies$actor_2_name, "")
movies$genres <- na_if(movies$genres, "")
movies$actor_1_name <- na_if(movies$actor_1_name, "")
movies$movie_title <- na_if(movies$movie_title, "")
movies$actor_3_name <- na_if(movies$actor_3_name, "")
movies$plot_keywords <- na_if(movies$plot_keywords, "")
movies$movie_imdb_link <- na_if(movies$movie_imdb_link, "")
movies$language <- na_if(movies$language, "")
movies$country <- na_if(movies$country, "")
movies$content_rating <- na_if(movies$content_rating, "")

broj_nedostajucih_poslije <- movies %>% is.na() %>% sum()

cat ("Broj novih NA vrijednosti: " , broj_nedostajucih_poslije - broj_nedostajucih_prije)

```

Sada ćemo proučiti gdje se nalazi najviše nedostajućih vrijednosti i odlučiti kako ćemo postupiti s njima.

```{r}
na_counts <- sapply(movies, function(x) sum(is.na(x)))
sort(na_counts, decreasing = TRUE)
```
Stupci s najviše nedostajućih vrijednosti su povezani s potrošnjom i zaradom na filmu. Za sada nećemo uklanjati nedostajuće vrijednosti jer čine dosta velik udio u uzorku podataka (883 od 5043), ali ćemo ih ukloniti prije analiza koje koriste navedene stupce.

## Uklanjanje duplikata

Pregledom skupa, uočena su ista imena filmova, ovaj problem riješiti ćemo uklanjanjem duplikata.

```{r}
movies <- distinct(.data = movies, movie_title, .keep_all = TRUE)
```

## Kategorijske varijable i uređivanje skupa

Za početak možemo uočiti neke varijable znakovnog tipa poput imena države i jezika filma možemo kategorizirati pretvaranjem u tip `factor`. Također, stupac `movie_imdb_link` nam neće biti potreban za daljnju analizu pa ćemo ga ukloniti. 

```{r, results='hold'}
movies$language <- factor(movies$language)
movies$country <- factor(movies$country)
movies$color <- factor(movies$color)
movies$content_rating <- factor(movies$content_rating)
movies$movie_imdb_link <- NULL

```


Trenutačno nam je stupac o žanrovima filma strukturiran tako da su svi žanrovi navedeni u jednom stupcu odvojeni okomitom crtom. Takav način mogao bi biti problematičan kod linearne regresije i treniranja modela, stoga ćemo stvoriti još jedan skup koji ćemo proširiti s stupcem za svaki postojeći žanr i vrijednostima 0 i 1 u zavisnosti je li film tog žanra ili ne.

```{r}
movies %>% separate_rows(genres, sep = "\\|") %>% count(genres, sort = TRUE)

movies_reg <- movies %>%
  separate_rows(genres, sep = "\\|") %>%
  mutate(value = 1) %>%
  pivot_wider(names_from  = genres, values_from = value, values_fill = 0)

#glimpse(movies_reg)[28:52]
```



## Zanimljivosti iz skupa podataka

Za početak, koristeći jednostavne upite koji podsjećaju na one u jeziku SQL, odgovorimo na nekoliko zanimljivih pitanja o filmovima korištenjem danog podatkovnog okvira.

### 5 najbolje ocijenjenih filmova na IMDb-u
```{r}
top5 <- movies %>% slice_max(order_by = imdb_score, n = 5) %>% 
  dplyr::select(movie_title, imdb_score)
top5
```
### 5 filmova s najviše ocjena korisnika
```{r}
top5_num_votes <- movies %>% slice_max(order_by = num_voted_users, n = 5) %>% 
  dplyr::select(movie_title, num_voted_users, imdb_score)
top5_num_votes
```
### 5 filmova s najviše ocjena kritičara
```{r}
top5_crit_votes <- movies %>% slice_max(order_by = num_critic_for_reviews, n = 5) %>% 
  dplyr::select(movie_title, num_critic_for_reviews, imdb_score)
top5_crit_votes
```

### 5 najskupljih filmova
```{r}
top5_budget <- movies %>% slice_max(order_by = budget, n = 5) %>% 
  dplyr::select(movie_title, budget, imdb_score)
top5_budget
```
Ovdje je zanimljivo primijetiti da su čak 3 animirana filma (Princess Mononoke, Steamboy, Akira) u top 5 najskupljih filmova.

### 5 filmova s najvećom zaradom od prodaje ulaznica
```{r}
top5_gross <- movies %>% slice_max(order_by = gross, n = 5) %>% 
  dplyr::select(movie_title, gross, imdb_score)
top5_gross
```
Kao što vidimo to su neki od najpoznatijih filmova današnjice.

### 5 crno-bijelih filmova s najboljim IMDb ocjenama

```{r}
top5_bw <- movies %>% filter(color != "Color") %>% 
  slice_max(order_by = imdb_score, n = 5) %>% 
  dplyr::select(movie_title, color, imdb_score)

top5_bw
```


## Vizualizacija podataka

U ovom dijelu analize, fokusirat ćemo se na grafičke prikaze varijabli podatkovnog skupa te odnose, odnosno zavisnosti parova varijabli. 

### Distribucija IMDb ocjena

Pogledajmo kako su distribuirane ocjene za filmove u podatkovnom okviru:

```{r, results='hold'}
ggplot(movies, aes(imdb_score)) + geom_density() + 
  scale_x_continuous(breaks = seq(0, 10, by = 0.5)) + 
  labs(title = "Distribucija IMDb ocjena", x = "IMDb ocjena", y = "Gustoca") + theme_bw()
summary(movies$imdb_score)
```

IMDb ocjena može biti bilo koji broj iz intervala [1, 10], a ocjene za filmove unutar promatranih podataka nalaze se unutar intervala [1.6, 9.5] s medijanom 6.6. Graf koji smo dobili nazivamo negativno zakrivljenom Gaussovom krivuljom. U nastavku analize pitat ćemo se imaju li neke druge dane varijable utjecaj na ovu ocjenu.

### Jezik filma 

Prvo ćemo proučiti jezik filma. Očekivano je pretpostaviti da je najviše filmova na engleskom jeziku. S takvim filmovima susrećemo se svakodnevno kada upalimo televizor. Pogledajmo sada broj filmova po pojedinom jeziku u našem skupu podataka.

```{r}
sort(table(movies[!is.na(movies$language), ]$language), decreasing = TRUE)
```
Vidimo da su naše pretpostavke istinite, filmova na engleskom ima znatno više nego ostalih. Uz filmove na engleskom u skupu su najviše zastupljeni filmovi na francuskom i španjolskom. Pogledajmo sada kako izgleda IMDb ocjena za jezika s više od po 10 filmova.

```{r}
movies_lan <- movies[!is.na(movies$language) , ]
movies_lan %>%
  count(language) %>%
  filter(n >= 10) %>%
  inner_join(movies, by = "language") %>%
  ggplot(aes(x = reorder(language, imdb_score, FUN = median),
             y = imdb_score)) +
  geom_boxplot() + scale_y_continuous() +
  labs(title = "IMDb score po jeziku (10+ filmova)",
       x = "Jezik",
       y = "IMDb ocjena") + theme_bw()
```

Na pravokutnim dijagramima možemo vidjeti raspone ocjena po najčešćim jezicima filmova, kao i medijan i ostale kvartile. Najveći raspon imaju filmovi na engleskom jeziku upravo zbog velike brojnosti istih. Najveći medijan ocjena imaju filmovi na njemačkom jeziku.

Pogledajmo još jednu zanimljivost vezanu za filmove koji nisu na engleskom jeziku.

#### 5 najbolje ocijenjenih filmova koji nisu na engleskom
```{r}
top5_not_english <- movies %>% filter(language != "English") %>% 
  slice_max(order_by = imdb_score, n = 5) %>% 
  dplyr::select(movie_title, language, imdb_score)

top5_not_english
```

### Država produkcije filma

Osim jezika imamo podatke i o državi u kojoj je film napravljen. Za očekivati je da su američki filmovi najbrojniji zbog snažnog utjecaja Hollywooda na američku filmsku industriju. Ovaj utjecaj najbolje prikazuje brojnost američkih filmova naspram ostalih:

```{r, results='hold'}
number_usa <- movies %>% filter(country == "USA") %>% count()
number_no_usa <- movies %>% filter(country != "USA") %>% count()

number_usa
number_no_usa
```

S otprilike trostruko većim brojem filmova, američka filmska industrija ima puno veći uzorak iz kojeg filmovi mogu biti bolje ili lošije ocijenjeni, ali pogledajmo sada tablice najbolje ocijenjenih američkih filmova i najbolje ocijenjenih filmova koji ne potječu iz Amerike:

```{r, results='hold'}
top5_usa <- movies %>% filter(country == "USA") %>% 
  slice_max(order_by = imdb_score, n = 5) %>%
  dplyr::select(movie_title, country, imdb_score) 
cat("5 najbolje ocijenjenih američkih filmova:\n")
top5_usa

```
```{r, results='hold'}
top5_no_usa <- movies %>% filter(country != "USA") %>% 
  slice_max(order_by = imdb_score, n = 5) %>%
  dplyr::select(movie_title, country, imdb_score) 
cat("5 najbolje ocijenjenih filmova koji nisu američki:\n")
top5_no_usa
```

Zanimljivo je uočiti da je unatoč malom broju filmova, ostatak svijeta proizveo jako dobro ocijenjene filmove.


### Filmski budžet i zarada od filma

Sljedeće varijable koje ćemo promatrati su budžet koji je utrošen za snimanje i produkciju filma te zarada od filma. Obje vrijednosti su zapisane u američkim dolarima, a kako su iznosi prilično visoki, u većini slučajeva ćemo koristiti logaritamsku transformaciju koja će nam urednije predstaviti podatke i ovisnosti o drugim varijablama. Kao česta praksa kod logaritamske transformacije dodajemo svim podacima vrijednost jedan iz predostrožnosti jer log(0) nije definirano.

```{r}
movies_budget <- movies[!is.na(movies$budget),]
movies_gross <- movies[!is.na(movies$gross),]

summary(movies_budget$budget)
summary(movies_gross$gross)
```

Vidimo da su vrijednosti zarade raspršenije od vrijednosti budžeta. Minimalna vrijednost zarade od filma iznosi 162, što se na prvi pogled čini kao krivo unesen podatak, daljnjim proučavanjem saznajemo da IMDb ocjena tog filma iznosi 5.7, što može donekle objasniti podatak o zaradi kao filmski neuspjeh.

### Omjer budžeta i ocjene

```{r}
cor(movies_budget$budget, movies_budget$imdb_score)

ggplot(movies_budget, aes(x = log(budget + 1), y = imdb_score)) +
  geom_point(alpha = 0.3) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red") +
  labs(title = "IMDb ocjena po budzetu filma",
       x = "Log(budzet)",
       y = "IMDb ocjena") + theme_bw()
```

Prema grafu i malom koeficijentu korelacije možemo zaključiti da nema linearne ovisnosti između ocjene i budžeta.

### Omjer zarade i ocjene
```{r}
cor(movies_gross$gross, movies_gross$imdb_score)

ggplot(movies_gross, aes(x = log(gross + 1), y = imdb_score)) +
  geom_point(alpha = 0.3) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red") +
  labs(title = "IMDB ocjena po zaradi od ulaznica",
       x = "Log(zarada od ulaznica)",
       y = "IMDb ocjena") + theme_bw()
```

Iako je u ovom slučaju koeficijent korelacije veći nego kod budžeta, i dalje ne možemo zaključiti postojanje linearne ovisnosti.


### Ovisnost budžeta i zarade od ulaznica


Pogledajmo koeficijent korelacije te graf ovisnosti logaritamskih vrijednosti budžeta filma i zarade od prodaje ulaznica.

```{r}
movies_money <- movies_gross[!is.na(movies_gross$budget),]

ggplot(movies_money, aes(x = log(budget + 1), y = log(gross + 1))) +
  geom_point(alpha = 0.3) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red") +
  labs(title = "Ovisnost budzeta i zarade od ulaznica",
       x = "Log (budzet)",
       y = "Log (zarada)") + theme_bw()

cor(log(movies_money$budget + 1),log(movies_money$gross + 1) )
```
Ono što slutimo po koeficijentu korelacije, a graf nam dodatno potvrđuje je da opravdano sumnjamo na postojanje linearna ovisnosti između dvije varijable. Vidimo da su točke na grafu dosta raspršene za male vrijednosti, ali za visoke iznose budžeta i zarade ovisnost se više naslućuje s određenim odstupanjima. Pokušajmo potvrditi ovu ovisnost linearnim modelom.

### Linearni model zarade i budžeta


Statistički istražimo postoji li formula koja opisuje zaradu od ulaznica preko budžeta: `zarada` = koeficijent * `budžet`.


```{r}
linMod <- lm(log(gross + 1) ~ log(budget + 1), data = movies_money)

summary(linMod)
```


Možemo vidjeti da postoji statistički značajna ovisnost između dvije logaritmirane varijable, ali R-squared = 0.35 pokazuje da model objašnjava samo trećinu varijance, što upućuje na samo umjerenu prediktivnu moć modela zbog prevelike raspršenosti podataka.


### Broj ocjena korisnika

Sljedeća varijabla koju ćemo istražiti je `num_voted_users` koja nam govori koliko korisnika IMDb stranice je dalo svoju ocjenu za film. Ovaj podatak nam može reći koliki doseg je film imao, ali moramo imati na umu da većina ljudi samo pogleda film a da ga ocijeni na internetu. 

```{r, results='hold'}
movies_glasovi <- movies[!is.na(movies$num_voted_users),]
ggplot(movies_glasovi, aes(x = log(num_voted_users + 1), y = imdb_score)) +
  geom_point(alpha = 0.3) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red") +
  labs(title = "IMDb score i broj ocjena",
       x = "Log broj ocjena",
       y = "IMDb ocjena") + theme_bw()
koef_korelacija_prije <- cor(movies_glasovi$num_voted_users, movies_glasovi$imdb_score)

```
Na ovom grafu vidimo veliku raspršenost ocjena za malen broj ocjenjivača. Zanimljivo je pogledati kako se podaci "nakupljaju", odnosno grupiraju za sve veći broj ocjena. Iz ovog razloga pogledat ćemo još jedan ovakav graf, ali samo za filmove koje je više od 100 tisuća ljudi ocijenilo. Ovime ćemo probati pokazati postoji li tendencija da što je film "bolji" to će više ljudi ostaviti svoju ocjenu za njega. Naravno treba biti oprezan na to da je dobra ocjena jedan od mogućih razloga zašto neki ljudi uopće saznaju za neke filmove i odluče ih pogledati, stoga veća gledanost može rezultirati i većim brojem glasova, ali nažalost podatak o gledanosti nemamo u našem podatkovnom okviru tako da ne možemo taj utjecaj potvrditi u ovom trenutku.

```{r}
movies_glasovi <- movies_glasovi[movies_glasovi$num_voted_users > 100000,]
ggplot(movies_glasovi, aes(x = log(num_voted_users + 1), y = imdb_score)) +
  geom_point(alpha = 0.3) +
  geom_smooth(formula = y ~ x, method = "lm", color = "red") +
  labs(title = "IMDb score i broj ocjena (filmovi s preko 100 tisuća ocjena)",
       x = "Log broj ocjena",
       y = "IMDb ocjena") + theme_bw()
koef_korelacija_poslije <- cor(movies_glasovi$num_voted_users, movies_glasovi$imdb_score)

```

Na ovom grafu vidimo jaču linearnu vezu, provjerimo s koeficijentom korelacije koliko su varijable zaista povezanije nakon odabiranja češće ocjenjivanih filmova.


```{r}
koef_korelacija_prije
koef_korelacija_poslije
```

Kao što smo i pretpostavili, koeficijent korelacije se povećao.


### Godina izlaska filma

Uz pomoć varijable `title_year` promotrimo trend IMDb ocjena po godinama izlaska filma. 


```{r}
movies_trend <- movies[!is.na(movies$title_year), ]
ggplot(movies_trend, aes(x = title_year, y = imdb_score)) +
  geom_point(alpha = 0.2) +
  geom_smooth(formula = y ~ x, method = "loess", color = "blue") +
  labs(title = "Trend IMDb ocjene kroz godine",
       x = "Godina",
       y = "IMDb ocjena") + theme_bw()

```

Ovaj graf nam pokazuje IMDb ocijene za filmove prema godinama izlaska. Možemo vidjeti kako je broj ocijenjenih filmova znatno veći za razdoblje nakon 1990. godine, a razlog tomu je podatak da je IMDb stranica nastala upravo 1990. godine, a kupljena od strane Amazona 1998. godine što joj je pridonijelo još većoj popularnosti. Promotrimo sada medijan ocjena za svaku zabilježenu godinu filma. Za ovaj graf uzimamo medijan jer je robusniji na stršeće vrijednosti.


```{r}
movies_trend <- movies_trend %>% group_by(title_year) %>% 
  summarise(median_rating = median(imdb_score))

ggplot(movies_trend, aes(x = title_year, y = median_rating)) + geom_point() + 
  geom_smooth(formula = y ~ x, method = "loess") + geom_line(group = 1) +
  labs(title = "Medijan IMDb ratinga kroz godine",
       x = "Godina",
       y = "Medijan IMDb ocjena") + theme_bw()
```

Ovaj graf daje nam par zanimljivih informacija. 2 najlošija medijana u 20.stoljeću dogodila su se u poslijeratnom periodu oba svjetska rata. Trend nam pokazuje da su ocjene novijih filmova lošije od ocjena starijih. Jedan od mogućih objašnjenja ovog trenda je da korisnici starije filmove češće gledaju jer su već čuli da je film jako dobar ili su vidjeli da ima jako dobru ocjenu pa su ga odlučili pogledat. Vjerojatno se radi o filmskim klasicima kojima se ljudi rado vraćaju i ponovo gledaju. Nakon osnutka IMDb-a korisnici su počeli ocjenjivati filmove sve češće, odnosno ocjenjivali bi filmove nakon što ih prvi puta pogledaju. Sa sve više filmova, došlo je i sve više lošije ocijenjenih filmova zbog kojih je median niži u 21.stoljeću. 

Istražimo sada kako se prosječan broj glasova mijenjao po godinama.

```{r}
movies_trend2 <- movies[!is.na(movies$num_voted_users) 
                        & !is.na(movies$title_year), ] %>% 
  group_by(title_year) %>% summarise(avg_votes = (mean(num_voted_users)))

ggplot(movies_trend2, aes(x = title_year, y = (avg_votes))) + 
  geom_point() + geom_smooth(formula = y ~ x, method = "loess")  +
  labs(title = "Prosjecan broja glasova po godinama",
       x = "Godina",
       y = "prosjecan broja glasova po filmu") + theme_bw()
```

Uz trend koji upućuje na povećanje prosječnog broja glasova, na ovom grafu primjećujemo i par točaka koje jako odstupaju od dugih. 3 godine s najvećim prosjekom su 1942., 1957., 1975. Pogledajmo koji su najbolje ocijenjeni filmovi iz tih godina.

```{r, results='hold'}
movies_trend3 <- movies[!is.na(movies$movie_title),] %>% group_by(title_year) %>% arrange(desc(imdb_score))
movies_1942 <- movies_trend3[movies_trend3$title_year == 1942, ] %>% slice_head(n = 3)
movies_1957 <- movies_trend3[movies_trend3$title_year == 1957, ] %>% slice_head(n = 3)
movies_1975 <- movies_trend3[movies_trend3$title_year == 1975, ] %>% slice_head(n = 3)

cat("Najbolje ocjenjeni filmovi iz 1942. godine: ",
paste(movies_1942$movie_title[!is.na(movies_1942$movie_title)], collapse = ", "), "\n")
cat("Najbolje ocjenjeni filmovi iz 1957. godine: ",
    paste(movies_1957$movie_title[!is.na(movies_1957$movie_title)], collapse = ", "),
     "\n")
cat("Najbolje ocjenjeni filmovi iz 1975. godine: ",
    paste(movies_1975$movie_title[!is.na(movies_1975$movie_title)], collapse = ", "),
     "\n")
```

Radi se o vrlo poznatim i uspješnim filmovima koje ljudi i dan danas gledaju.


### Žanr filma

Promotrimo sada varijablu `genres`. U uvodnom dijelu smo upoznali kako ovaj stupac izgleda kada smo ga pripremali za linearnu regresiju. Sada ćemo raditi nad originalnim stupcem i pogledati prosječnu ocjenu po žanru. Promatrat ćemo samo žanrove sa 100 ili više filmova.

```{r}
genre_stats <- movies %>%
  separate_rows(genres, sep = "\\|") %>%
  group_by(genres) %>%
  summarise(avg_rating = mean(imdb_score, na.rm = TRUE), n = n()) %>%
  filter(n >= 100) %>%
  arrange(desc(avg_rating)) %>%
  slice_head( n = 8) 

ggplot(genre_stats,
       aes(x = reorder(genres, avg_rating), y = avg_rating, fill = genres)) +
  geom_col(color = "black") + scale_fill_brewer(palette = "BuPu") +
  scale_y_continuous(name ="Prosjecna ocjena",  breaks = c(1, 5, 6, 6.5, 7, 7.5, 8)) +
  labs(title = "Prosjecan IMDb ocjena po zanru",
       x = "Zanr") + theme_bw()


```

Graf nam pokazuje kako je prosjek ocjena najveći za dokumentarce, biografije, povijesne te ratne filmove. Filmovi tog žanra znaju biti često nagrađivani prestižnim filmskim nagradama zbog tematike kojoj se bave.

## Linearni model ratinga

Pokušajmo sada odrediti linearnu funkciju koja najbolje opisuje IMDb rating. Za početak moramo ukloniti sve stupce koji nam ne trebaju, a to su svi znakovni stupci koji nisu kategorijski. Također, logaritmirati ćemo veće brojke poput zarade, budžeta i broja lajkova.

```{r}
movies_reg <- movies_reg %>% dplyr::select(-movie_title, -director_name, -actor_1_name, -actor_2_name, -actor_3_name, -plot_keywords) 

movies_reg <- movies_reg %>%
  mutate(
    log_budget = log(budget + 1),
    log_gross = log(gross + 1),
    log_votes = log(num_voted_users + 1),
    log_user_reviews = log(num_user_for_reviews + 1),
    log_cast_likes = log(cast_total_facebook_likes + 1),
    log_director_likes = log(director_facebook_likes + 1),
    log_movies_fb_likes = log(movie_facebook_likes + 1)
  ) %>%
  dplyr::select(-budget, -gross, -num_voted_users,
         -num_user_for_reviews,
         -cast_total_facebook_likes, -director_facebook_likes, -movie_facebook_likes)
```


Kako u skupu imamo puno kategorija za varijablu države i jezika filma, zbog brojnosti pojednostavit ćemo stupce tako da ćemo za `engLanguage` upisati 1 ako je film na engleskom jeziku, a 0 ako nije te za `USA_country` upisati 1 ako je američki film, a 0 ako nije. Za kraj ćemo obrisati sve nedostajuće vrijednosti bi svi modeli radili nad istim podacima.

```{r}
movies_reg <- movies_reg %>%
  mutate(
    engLanguage = if_else(language == "English", 1L, 0L),
    USA_country = if_else(country == "USA", 1L, 0L)
  ) %>%
  dplyr::select(-language, -country)

movies_reg <- movies_reg %>% drop_na()
```


### Iterativna (stepwise) izgradnja prediktivnog modela

Prvo ćemo stvoriti jedan linearni model koji sadrži sve varijable iz tablice `movies_reg` te jedan potpuno prazni linearni model. Uz pomoć funkcije `stepAIC`
 stvorit ćemo nova 2 modela. Jedan od njih (`lm1`) će nastati iterativnom selekcijom prediktora od punog modela, dok će drugi (`lm2`) od potpuno praznog. 

```{r, results='hold'}
lm_sve <- lm(imdb_score ~ ., data = movies_reg)   
lm_prazan <- lm(imdb_score ~ 1, data = movies_reg)

lm1 <- stepAIC(lm_sve, direction = "backward", trace = 0)
lm2 <- stepAIC(lm_prazan, scope = list(upper = lm_sve, lower = lm_prazan), direction = "forward", trace = 0)



```

Vrijednost koja nam govori o tome koliko je model prediktivan i koliko varijance objašnjava naziva se prilagođeni koeficijent determinacije (`Adjusted R-squared`). Usporedimo vrijednosti početnog modela i 2 modela dobivena stepwise funkcijom.

```{r, results='hold'}
cat("Adjusted R-squared vrijednosti od punog modela: ", summary(lm_sve)$adj.r.squared, '\n')
cat("Adjusted R-squared vrijednosti od lm1 modela: ", summary(lm1)$adj.r.squared,'\n')
cat("Adjusted R-squared vrijednosti od lm2 modela: ", summary(lm2)$adj.r.squared,'\n')
```

Usporedba prilagođenih koeficijenata determinacije pokazuje da iterativna selekcija prediktora nije dovela do značajnog poboljšanja objašnjene varijance u odnosu na puni model, što sugerira da većina varijabli doprinosi modelu ili da su njihovi učinci relativno mali. 

Pogledajmo detaljnije `lm1` model.

```{r}
summary(lm1)
```

Iz ispisa možemo vidjeti koje su varijable statistički značajno (***) povezane s IMDb ocjenom. Neke od njih koje najviše pridonose boljoj ocjeni su: `num_critic_for_reviews`, `duration` i `Animation`. A neke koje najviše negativno utječu su: `title_year`, `log_gross` i `Horror`. 

Valja napomenuti da statistička značajnost pojedinih varijabli ne implicira nužno uzročnu povezanost, već isključivo njihovu povezanost s IMDb ocjenom unutar promatranog modela.

### Kolinearnost ulaznih varijabli

Sada ćemo provjeriti kako su ulazni podaci međusobno korelirani.

```{r, warning=FALSE}
moviesNumInputs <- movies_reg %>% dplyr::select(color, num_critic_for_reviews, duration, 
    actor_1_facebook_likes ,facenumber_in_poster , content_rating ,
    title_year , aspect_ratio , Action , Fantasy , `Sci-Fi` , 
    Thriller , Documentary , Romance , Animation , Comedy , Family , 
    Drama , Horror , Biography , Music , log_budget , log_gross , 
    log_votes , log_user_reviews , log_cast_likes , log_director_likes , 
    engLanguage , USA_country) %>% select_if(is.numeric)

corMatrix <- moviesNumInputs %>% cor () %>% round(digits=2)
dimnames(corMatrix) <- NULL


corrplot(corMatrix, method = "color", type = "upper", tl.cex = 0.7)

```

Većina parova varijabli u korelacijskoj matrici ne pokazuju izrazito visoke korelacijske vrijednosti (vrijednosti su približne 0), što upućuje na nisku razinu linearne povezanosti među prediktorima.


### Multikolinearnost

Kako bi provjerili odsutnost multikolinearnosti, koja je jedna od ključnih pretpostavki višestruke linearne regresije koristit ćemo faktor inflacije varijance (VIF).

```{r}
vif(lm1)
```

Analiza multikolinearnosti pokazala je da su sve VIF vrijednosti manje od 2.5, čime je potvrđeno da multikolinearnost ne predstavlja problem u promatranom regresijskom modelu.

### Provjera normalnosti reziduala

Za kraj ćemo provjeriti pretpostavke višestrukog regresijskog modela vezane uz reziduale. Prikazat ćemo odnos standardiziranih reziduala i predviđenih vrijednosti, gustoću razdiobe standardiziranih reziduala te kvantil-kvantil (Q–Q) graf reziduala.

```{r, warning=FALSE}
predikcije <- augment(lm1)
g1 <- ggplot(predikcije, aes(x = .fitted, y = .std.resid)) + geom_point()+ geom_hline(yintercept = 0, color = "blue") + theme_bw()

g2 <- ggplot(predikcije, aes(x = .std.resid)) + geom_density() + theme_bw()

g3 <- ggplot(predikcije, aes(sample = .resid)) + geom_qq() + theme_bw()
grid.arrange(g1, g2, g3, ncol= 2)
```

Vizualni pregledi reziduala ukazuju na to da su pretpostavke normalnosti reziduala u velikoj mjeri zadovoljene.
Gustoća razdiobe standardiziranih reziduala približno je simetrična, dok Q–Q graf pokazuje blaga odstupanja u repovima, što je očekivano kod većih uzoraka te ne predstavlja ozbiljno kršenje pretpostavke normalnosti. 


